<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Tool - 307 Error Investigation</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007acc; }
        .result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 3px; }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .warning { border-left: 4px solid #ffc107; }
        button { padding: 10px 20px; margin: 5px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #005a9e; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .status-307 { background: #ffebee; border: 2px solid #f44336; }
    </style>
</head>
<body>
    <h1>üîç Browser API Debug Tool - 307 Error Investigation</h1>
    
    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="results"></div>
    </div>

    <div class="test-section">
        <h2>üß™ API Tests</h2>
        <button onclick="testLocalGraphQL()">Test Local GraphQL</button>
        <button onclick="testLocalProxyAPI()">Test Local Proxy API</button>
        <button onclick="testBrowserFetch()">Test Browser Fetch Patterns</button>
        <button onclick="testWithDifferentHeaders()">Test Different Headers</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function addResult(title, content, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            if (type === 'error' && content.includes('307')) {
                div.className += ' status-307';
            }
            div.innerHTML = `<strong>${title}</strong><pre>${content}</pre>`;
            resultsDiv.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testLocalGraphQL() {
            addResult('üóÑÔ∏è Testing Local GraphQL API...', 'Starting GraphQL test');
            
            try {
                const response = await fetch('/api/graphql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: '{ prefecture { code name hiragana } }'
                    })
                });

                addResult('GraphQL Response Status', `${response.status} ${response.statusText}`, 
                    response.status === 307 ? 'error' : response.ok ? 'success' : 'warning');

                addResult('GraphQL Response Headers', JSON.stringify([...response.headers.entries()], null, 2));

                if (response.ok) {
                    const data = await response.json();
                    addResult('GraphQL Data', `Success: Retrieved ${data.data?.prefecture?.length || 0} prefectures`, 'success');
                } else {
                    const text = await response.text();
                    addResult('GraphQL Error', `Status: ${response.status}\\nResponse: ${text}`, 'error');
                }
            } catch (error) {
                addResult('GraphQL Fetch Error', `Error: ${error.message}\\nStack: ${error.stack}`, 'error');
            }
        }

        async function testLocalProxyAPI() {
            addResult('üîß Testing Local Proxy API...', 'Starting Proxy API test');
            
            try {
                const response = await fetch('/api/geo/prefectures', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                addResult('Proxy Response Status', `${response.status} ${response.statusText}`, 
                    response.status === 307 ? 'error' : response.ok ? 'success' : 'warning');

                addResult('Proxy Response Headers', JSON.stringify([...response.headers.entries()], null, 2));

                if (response.ok) {
                    const data = await response.json();
                    addResult('Proxy Data', `Success: Retrieved ${data.prefectures?.length || 0} prefectures`, 'success');
                } else {
                    const text = await response.text();
                    addResult('Proxy Error', `Status: ${response.status}\\nResponse: ${text}`, 'error');
                }
            } catch (error) {
                addResult('Proxy Fetch Error', `Error: ${error.message}\\nStack: ${error.stack}`, 'error');
            }
        }

        async function testBrowserFetch() {
            addResult('üåê Testing Different Fetch Patterns...', 'Starting browser fetch pattern tests');
            
            const patterns = [
                {
                    name: 'Standard Fetch',
                    options: {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: '{ prefecture { code name hiragana } }' })
                    }
                },
                {
                    name: 'Fetch with Cache Control',
                    options: {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Cache-Control': 'no-cache'
                        },
                        body: JSON.stringify({ query: '{ prefecture { code name hiragana } }' }),
                        cache: 'no-store'
                    }
                },
                {
                    name: 'Fetch with Additional Headers',
                    options: {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({ query: '{ prefecture { code name hiragana } }' })
                    }
                }
            ];

            for (const pattern of patterns) {
                try {
                    addResult(`Testing: ${pattern.name}`, 'Making request...');
                    
                    const response = await fetch('/api/graphql', pattern.options);
                    
                    addResult(`${pattern.name} - Status`, `${response.status} ${response.statusText}`, 
                        response.status === 307 ? 'error' : response.ok ? 'success' : 'warning');
                    
                    if (response.status === 307) {
                        addResult(`${pattern.name} - 307 DETECTED!`, 
                            `Location: ${response.headers.get('location') || 'Not provided'}\\n` +
                            `Headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`, 'error');
                    }
                    
                } catch (error) {
                    addResult(`${pattern.name} - Error`, `${error.message}`, 'error');
                }
            }
        }

        async function testWithDifferentHeaders() {
            addResult('üîß Testing Different Header Configurations...', 'Starting header configuration tests');
            
            const headerConfigs = [
                { name: 'Minimal Headers', headers: {} },
                { name: 'JSON Only', headers: { 'Content-Type': 'application/json' } },
                { name: 'With Accept', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' } },
                { name: 'With User-Agent', headers: { 
                    'Content-Type': 'application/json', 
                    'User-Agent': 'Mozilla/5.0 (compatible; Debug/1.0)' 
                }},
                { name: 'With Origin', headers: { 
                    'Content-Type': 'application/json',
                    'Origin': window.location.origin
                }},
                { name: 'All Headers', headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache',
                    'Origin': window.location.origin,
                    'Referer': window.location.href
                }}
            ];

            for (const config of headerConfigs) {
                try {
                    const response = await fetch('/api/graphql', {
                        method: 'POST',
                        headers: config.headers,
                        body: JSON.stringify({ query: '{ prefecture { code name hiragana } }' })
                    });

                    const statusType = response.status === 307 ? 'error' : response.ok ? 'success' : 'warning';
                    addResult(`${config.name}`, 
                        `Status: ${response.status} ${response.statusText}\\n` +
                        `Headers sent: ${JSON.stringify(config.headers, null, 2)}`, statusType);

                    if (response.status === 307) {
                        addResult(`üö® 307 FOUND in ${config.name}!`, 
                            `Location: ${response.headers.get('location')}\\n` +
                            `All response headers: ${JSON.stringify([...response.headers.entries()], null, 2)}`, 'error');
                    }
                    
                } catch (error) {
                    addResult(`${config.name} - Error`, error.message, 'error');
                }
            }
        }

        // Auto-run initial test
        window.addEventListener('load', () => {
            addResult('üöÄ Browser API Debug Tool Loaded', 
                `User Agent: ${navigator.userAgent}\\n` +
                `Location: ${window.location.href}\\n` +
                `Ready to test APIs for 307 errors`);
        });
    </script>
</body>
</html>